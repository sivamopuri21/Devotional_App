// Prisma Schema for Swadhrama Parirakshna
// Feature 1: User Authentication & Household Management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DELETED
}

enum UserRole {
  MEMBER
  PROVIDER
  ADMIN
}

enum HouseholdRole {
  HEAD
  ADULT
  CHILD
}

enum MemberStatus {
  ACTIVE
  REMOVED
  LEFT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum AddressType {
  HOME
  OFFICE
  TEMPLE
  OTHER
}

enum TokenType {
  REFRESH
  RESET_PASSWORD
}

enum SocialProvider {
  GOOGLE
  APPLE
}

enum OtpPurpose {
  REGISTRATION
  LOGIN
  PASSWORD_RESET
  INVITE
}

// Models
model User {
  id                  String     @id @default(uuid())
  email               String?    @unique
  phone               String?    @unique
  passwordHash        String?    @map("password_hash")
  emailVerified       Boolean    @default(false) @map("email_verified")
  phoneVerified       Boolean    @default(false) @map("phone_verified")
  status              UserStatus @default(PENDING)
  role                UserRole   @default(MEMBER)
  failedLoginAttempts Int        @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime?  @map("locked_until")
  lastLoginAt         DateTime?  @map("last_login_at")
  passwordChangedAt   DateTime?  @map("password_changed_at")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  // Relations
  profile                  UserProfile?
  headOfHouseholds         Household[]       @relation("HouseholdHead")
  householdMembers         HouseholdMember[]
  invitesSent              HouseholdMember[] @relation("InvitedBy")
  householdInvitesSent     HouseholdInvite[] @relation("Inviter")
  householdInvitesReceived HouseholdInvite[] @relation("Invitee")
  addresses                Address[]
  authTokens               AuthToken[]
  socialAccounts           SocialAccount[]
  otpCodes                 OtpCode[]
  auditLogs                AuditLog[]
  memberRequests           ServiceRequest[]  @relation("MemberRequests")
  providerRequests         ServiceRequest[]  @relation("ProviderRequests")
  notifications            Notification[]

  @@map("users")
}

model UserProfile {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  fullName           String    @map("full_name")
  displayName        String?   @map("display_name")
  avatarUrl          String?   @map("avatar_url")
  dateOfBirth        DateTime? @map("date_of_birth")
  placeOfBirth       String?   @map("place_of_birth")
  timeOfBirth        String?   @map("time_of_birth")
  gotra              String?
  nakshatra          String?
  rashi              String?
  languagePreference String    @default("en") @map("language_preference")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Household {
  id         String       @id @default(uuid())
  name       String
  headUserId String       @map("head_user_id")
  status     MemberStatus @default(ACTIVE)
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  head      User              @relation("HouseholdHead", fields: [headUserId], references: [id])
  members   HouseholdMember[]
  invites   HouseholdInvite[]
  addresses Address[]

  @@map("households")
}

model HouseholdMember {
  id          String        @id @default(uuid())
  householdId String        @map("household_id")
  userId      String        @map("user_id")
  role        HouseholdRole @default(ADULT)
  status      MemberStatus  @default(ACTIVE)
  invitedById String?       @map("invited_by")
  joinedAt    DateTime      @default(now()) @map("joined_at")
  leftAt      DateTime?     @map("left_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedBy User?     @relation("InvitedBy", fields: [invitedById], references: [id])

  @@unique([householdId, userId])
  @@map("household_members")
}

model HouseholdInvite {
  id             String        @id @default(uuid())
  householdId    String        @map("household_id")
  inviterId      String        @map("inviter_id")
  inviteeContact String        @map("invitee_contact")
  inviteeUserId  String?       @map("invitee_user_id")
  role           HouseholdRole @default(ADULT)
  token          String        @unique
  status         InviteStatus  @default(PENDING)
  expiresAt      DateTime      @map("expires_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  respondedAt    DateTime?     @map("responded_at")

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  inviter   User      @relation("Inviter", fields: [inviterId], references: [id])
  invitee   User?     @relation("Invitee", fields: [inviteeUserId], references: [id])

  @@map("household_invites")
}

model Address {
  id          String      @id @default(uuid())
  userId      String?     @map("user_id")
  householdId String?     @map("household_id")
  type        AddressType @default(HOME)
  label       String?
  line1       String
  line2       String?
  landmark    String?
  city        String
  state       String
  pincode     String
  country     String      @default("India")
  latitude    Decimal?    @db.Decimal(10, 8)
  longitude   Decimal?    @db.Decimal(11, 8)
  isPrimary   Boolean     @default(false) @map("is_primary")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  household Household? @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model AuthToken {
  id            String    @id @default(uuid())
  userId        String    @map("user_id")
  tokenHash     String    @map("token_hash")
  tokenType     TokenType @default(REFRESH) @map("token_type")
  deviceInfo    Json?     @map("device_info")
  ipAddress     String?   @map("ip_address")
  userAgent     String?   @map("user_agent")
  expiresAt     DateTime  @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  revokedAt     DateTime? @map("revoked_at")
  revokedReason String?   @map("revoked_reason")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@map("auth_tokens")
}

model SocialAccount {
  id             String         @id @default(uuid())
  userId         String         @map("user_id")
  provider       SocialProvider
  providerUserId String         @map("provider_user_id")
  email          String?
  name           String?
  avatarUrl      String?        @map("avatar_url")
  accessToken    String?        @map("access_token")
  refreshToken   String?        @map("refresh_token")
  tokenExpiresAt DateTime?      @map("token_expires_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@map("social_accounts")
}

model OtpCode {
  id          String     @id @default(uuid())
  userId      String?    @map("user_id")
  codeHash    String     @map("code_hash")
  purpose     OtpPurpose
  contact     String
  attempts    Int        @default(0)
  maxAttempts Int        @default(3) @map("max_attempts")
  expiresAt   DateTime   @map("expires_at")
  verifiedAt  DateTime?  @map("verified_at")
  createdAt   DateTime   @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contact])
  @@map("otp_codes")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// Service Request Enums
enum ServiceType {
  HomamYagam
  HomePooja
  PoojaSamagri
  FamilyConnect
}

enum ServiceRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
  WITHDRAWN
}

model ServiceRequest {
  id          String               @id @default(uuid())
  memberId    String               @map("member_id")
  providerId  String?              @map("provider_id")
  serviceType ServiceType          @map("service_type")
  date        DateTime
  time        String
  location    String?
  notes       String?
  status      ServiceRequestStatus @default(PENDING)
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  member   User  @relation("MemberRequests", fields: [memberId], references: [id], onDelete: Cascade)
  provider User? @relation("ProviderRequests", fields: [providerId], references: [id])

  @@index([memberId])
  @@index([providerId])
  @@index([status])
  @@map("service_requests")
}

model Notification {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  message     String
  type        String // SERVICE_REQUEST_NEW, SERVICE_REQUEST_ACCEPTED, etc.
  referenceId String?  @map("reference_id") // e.g. service request id
  read        Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}
